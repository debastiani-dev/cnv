{% extends 'layouts/base_dashboard.html' %}
{% load i18n static %}

{% block title %}{{ cattle.tag }} - {{ cattle.name|default:"Cattle Detail" }}{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8">
    
    <!-- Breadcrumb / Back Navigation -->
    <div class="mb-8">
        <a href="{% url 'cattle:list' %}" class="text-sm font-medium text-gray-500 hover:text-gray-700 flex items-center">
            <svg class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M17 10a.75.75 0 01-.75.75H5.612l4.158 3.96a.75.75 0 11-1.04 1.08l-5.5-5.25a.75.75 0 010-1.08l5.5-5.25a.75.75 0 111.04 1.08L5.612 9.25H16.25A.75.75 0 0117 10z" clip-rule="evenodd" />
            </svg>
            {% trans "Back to Cattle List" %}
        </a>
    </div>

    <div class="overflow-hidden rounded-lg bg-white shadow ring-1 ring-black ring-opacity-5">
        <!-- Header / Banner -->
        <div class="h-32 bg-stone-400"></div>
        
        <div class="px-4 pb-6 sm:px-6">
            <!-- Profile Info Wrapper -->
            <div class="grid grid-cols-1 sm:grid-cols-[auto_1fr] gap-x-8 items-end">
                <!-- Container 1: Image -->
                <div class="flex -mt-16 sm:-mt-24 z-10 sm:block justify-center sm:justify-start p-2">
                    {% if cattle.image %}
                        <img class="h-24 w-24 rounded-full ring-4 ring-white sm:h-32 sm:w-32 object-cover bg-white" style="max-width: 8rem; max-height: 8rem;" src="{{ cattle.image.url }}" alt="{{ cattle.tag }}">
                    {% else %}
                        <img class="h-24 w-24 rounded-full ring-4 ring-white sm:h-32 sm:w-32 object-cover bg-white" style="max-width: 8rem; max-height: 8rem;" src="{% static 'img/default_cow.png' %}" alt="Default Cow">
                    {% endif %}
                </div>
                
                <!-- Container 2: Name & Details -->
                <div class="min-w-0 flex-1 pb-1 sm:pb-2 text-center sm:text-left pt-2 sm:pt-0">
                     <h1 class="truncate text-2xl font-bold text-gray-900">{{ cattle.name|default:cattle.tag }}</h1>
                     <p class="text-sm font-medium text-gray-500">TAG: {{ cattle.tag }}</p>
                </div>
            </div>

        <!-- Details Grid -->
        <dl class="mt-6">
            <!-- Tag -->
            <div class="border-t border-gray-100 bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                <dt class="text-sm font-medium text-gray-500">{% trans "Tag / ID" %}</dt>
                <dd class="mt-1 text-sm text-gray-900 sm:col-span-2 sm:mt-0">{{ cattle.tag }}</dd>
            </div>

            <!-- Name -->
            <div class="border-t border-gray-100 bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                <dt class="text-sm font-medium text-gray-500">{% trans "Name" %}</dt>
                <dd class="mt-1 text-sm text-gray-900 sm:col-span-2 sm:mt-0">{{ cattle.name|default:"-" }}</dd>
            </div>

            <!-- Breed -->
            <div class="border-t border-gray-100 bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                <dt class="text-sm font-medium text-gray-500">{% trans "Breed" %}</dt>
                <dd class="mt-1 text-sm text-gray-900 sm:col-span-2 sm:mt-0">{{ cattle.breed|default:"-" }}</dd>
            </div>

            <!-- Status -->
            <div class="border-t border-gray-100 bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                <dt class="text-sm font-medium text-gray-500">{% trans "Status" %}</dt>
                <dd class="mt-1 text-sm text-gray-900 sm:col-span-2 sm:mt-0">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                            {% if cattle.status == 'available' %} bg-green-100 text-green-800
                            {% elif cattle.status == 'sold' %} bg-blue-100 text-blue-800
                            {% elif cattle.status == 'dead' %} bg-red-100 text-red-800
                            {% else %} bg-gray-100 text-gray-800 {% endif %}">
                            {{ cattle.get_status_display }}
                        </span>
                </dd>
            </div>

            <!-- Current Location (New) -->
            <div class="border-t border-gray-100 bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                <dt class="text-sm font-medium text-gray-500">{% trans "Location" %}</dt>
                <dd class="mt-1 text-sm text-gray-900 sm:col-span-2 sm:mt-0">
                    {% if cattle.location %}
                    <a href="{% url 'locations:detail' cattle.location.pk %}" class="font-medium text-indigo-600 hover:text-indigo-900">
                        {{ cattle.location.name }}
                    </a>
                    {% else %}
                    <span class="text-gray-400">{% trans "Not assigned" %}</span>
                    {% endif %}
                </dd>
            </div>

            <!-- Reproduction Status (New) -->
            <div class="border-t border-gray-100 bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                <dt class="text-sm font-medium text-gray-500">{% trans "Reproduction Status" %}</dt>
                <dd class="mt-1 text-sm text-gray-900 sm:col-span-2 sm:mt-0">
                     <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                            {% if cattle.reproduction_status == 'pregnant' %} bg-purple-100 text-purple-800
                            {% elif cattle.reproduction_status == 'bred' %} bg-blue-100 text-blue-800
                            {% elif cattle.reproduction_status == 'lactating' %} bg-pink-100 text-pink-800
                            {% else %} bg-gray-100 text-gray-800 {% endif %}">
                            {{ cattle.get_reproduction_status_display|default:"-" }}
                        </span>
                </dd>
            </div>

            <!-- Weight -->
            <div class="border-t border-gray-100 bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                <dt class="text-sm font-medium text-gray-500">{% trans "Weight" %}</dt>
                <dd class="mt-1 text-sm text-gray-900 sm:col-span-2 sm:mt-0">
                    {% if cattle.weight_kg %}
                        {{ cattle.weight_kg }} kg
                    {% else %}
                        -
                    {% endif %}
                </dd>
            </div>

            <!-- Sex & Electronic ID -->
            <div class="border-t border-gray-100 bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                <dt class="text-sm font-medium text-gray-500">{% trans "Sex" %}</dt>
                <dd class="mt-1 text-sm text-gray-900 sm:col-span-2 sm:mt-0">{{ cattle.get_sex_display }}</dd>
            </div>
            <div class="border-t border-gray-100 bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                <dt class="text-sm font-medium text-gray-500">{% trans "Electronic ID" %}</dt>
                <dd class="mt-1 text-sm text-gray-900 sm:col-span-2 sm:mt-0">{{ cattle.electronic_id|default:"-" }}</dd>
            </div>

            <!-- Sire -->
            <div class="border-t border-gray-100 bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                <dt class="text-sm font-medium text-gray-500">{% trans "Sire" %}</dt>
                <dd class="mt-1 text-sm text-gray-900 sm:col-span-2 sm:mt-0">
                    {% if cattle.sire %}
                        <a href="{% url 'cattle:detail' cattle.sire.pk %}" class="text-indigo-600 hover:text-indigo-900">{{ cattle.sire.tag }} ({{ cattle.sire.name|default:"-" }})</a>
                    {% else %}
                        {{ cattle.sire_external_id|default:"-" }}
                    {% endif %}
                </dd>
            </div>

            <!-- Dam -->
            <div class="border-t border-gray-100 bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                <dt class="text-sm font-medium text-gray-500">{% trans "Dam" %}</dt>
                <dd class="mt-1 text-sm text-gray-900 sm:col-span-2 sm:mt-0">
                    {% if cattle.dam %}
                        <a href="{% url 'cattle:detail' cattle.dam.pk %}" class="text-indigo-600 hover:text-indigo-900">{{ cattle.dam.tag }} ({{ cattle.dam.name|default:"-" }})</a>
                    {% else %}
                        {{ cattle.dam_external_id|default:"-" }}
                    {% endif %}
                </dd>
            </div>

            <!-- Birth Date -->
            <div class="border-t border-gray-100 bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                <dt class="text-sm font-medium text-gray-500">{% trans "Birth Date" %}</dt>
                <dd class="mt-1 text-sm text-gray-900 sm:col-span-2 sm:mt-0">{{ cattle.birth_date|date:"SHORT_DATE_FORMAT"|default:"-" }} ({{ cattle.age }})</dd>
            </div>

            <!-- Notes -->
            <div class="border-t border-gray-100 bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                <dt class="text-sm font-medium text-gray-500">{% trans "Notes" %}</dt>
                <dd class="mt-1 text-sm text-gray-900 sm:col-span-2 sm:mt-0 whitespace-pre-line">{{ cattle.notes|default:"-" }}</dd>
            </div>
        </dl>
        
        <!-- Footer / Action Buttons -->
        <div class="border-t border-gray-200 bg-gray-50 px-4 py-4 sm:px-6 flex justify-end space-x-4">
             <a href="{% url 'cattle:update' cattle.pk %}" class="inline-flex justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                <svg class="-ml-0.5 mr-1.5 h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" />
                    <path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z" />
                </svg>
                {% trans "Edit Cattle" %}
            </a>
            <a href="{% url 'cattle:delete' cattle.pk %}" class="inline-flex justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500">
                {% trans "Delete Cattle" %}
            </a>
        </div>
    </div>


    <!-- Pending Tasks Section -->
    <div class="mt-8 overflow-hidden rounded-lg bg-white shadow ring-1 ring-black ring-opacity-5 mb-8">
        <div class="px-4 py-5 sm:px-6 flex justify-between items-center">
            <div>
                 <h3 class="text-base font-semibold leading-6 text-gray-900">{% trans "Pending Tasks" %}</h3>
                 <p class="mt-1 text-sm text-gray-500">{% trans "Action items linked to this animal." %}</p>
            </div>
             <a href="{% url 'tasks:create' %}?related_to={{ cattle.pk }}" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-plus-lg"></i> {% trans "Add Task" %}
            </a>
        </div>
        <div class="border-t border-gray-200">
             {% if pending_tasks %}
             <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-300">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-6">{% trans "Due Date" %}</th>
                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">{% trans "Title" %}</th>
                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">{% trans "Priority" %}</th>
                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">{% trans "Assigned To" %}</th>
                            <th scope="col" class="px-3 py-3.5 text-right text-sm font-semibold text-gray-900">{% trans "Action" %}</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 bg-white">
                        {% for task in pending_tasks %}
                        <tr>
                            <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium {% if task.is_overdue %}text-red-600{% else %}text-gray-900{% endif %} sm:pl-6">
                                {{ task.due_date|date:"SHORT_DATE_FORMAT" }}
                                {% if task.is_overdue %} <i class="bi bi-exclamation-circle-fill ml-1" title="Overdue"></i>{% endif %}
                            </td>
                            <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-900">
                                <a href="{% url 'tasks:detail' task.pk %}" class="font-medium hover:underline">{{ task.title }}</a>
                            </td>
                            <td class="whitespace-nowrap px-3 py-4 text-sm">
                                {% if task.priority == 'HIGH' %}<span class="inline-flex items-center rounded-md bg-yellow-50 px-2 py-1 text-xs font-medium text-yellow-800 ring-1 ring-inset ring-yellow-600/20">High</span>
                                {% elif task.priority == 'CRITICAL' %}<span class="inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-xs font-medium text-red-700 ring-1 ring-inset ring-red-600/10">Critical</span>
                                {% else %}<span class="inline-flex items-center rounded-md bg-gray-50 px-2 py-1 text-xs font-medium text-gray-600 ring-1 ring-inset ring-gray-500/10">{{ task.get_priority_display }}</span>
                                {% endif %}
                            </td>
                            <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">{{ task.assigned_to.get_full_name|default:"-" }}</td>
                             <td class="whitespace-nowrap px-3 py-4 text-sm text-right">
                                <a href="{% url 'tasks:update' task.pk %}" class="text-indigo-600 hover:text-indigo-900">{% trans "Edit" %}</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
             </div>
             {% else %}
             <div class="px-4 py-5 sm:px-6 text-sm text-gray-500 text-center">
                 {% trans "No pending tasks." %}
             </div>
             {% endif %}
        </div>
    </div>

    <!-- Performance History Section -->
    <div class="mt-8 overflow-hidden rounded-lg bg-white shadow ring-1 ring-black ring-opacity-5 mb-8">
        <div class="px-4 py-5 sm:px-6">
            <h3 class="text-base font-semibold leading-6 text-gray-900">{% trans "Performance History" %}</h3>
            <p class="mt-1 text-sm text-gray-500">{% trans "Weight records and growth performance." %}</p>
        </div>
        <div class="border-t border-gray-200 p-4">
            {% if weight_history %}
                <!-- Chart Container -->
                <div id="weightChart" class="w-full h-64 mb-6"></div>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-300">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-6">{% trans "Date" %}</th>
                                <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">{% trans "Weight (kg)" %}</th>
                                <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">{% trans "ADG (kg/d)" %}</th>
                                <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">{% trans "Session" %}</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 bg-white">
                            {% for record in weight_history %}
                            <tr>
                                <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-6">{{ record.session.date|date:"SHORT_DATE_FORMAT" }}</td>
                                <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-900">{{ record.weight_kg }}</td>
                                <td class="whitespace-nowrap px-3 py-4 text-sm font-medium {% if record.adg and record.adg > 0 %}text-green-600{% elif record.adg and record.adg < 0 %}text-red-600{% else %}text-gray-500{% endif %}">
                                    {{ record.adg|default:"-" }}
                                </td>
                                <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                                    <a href="{% url 'weight:session-detail' record.session.pk %}" class="text-indigo-600 hover:text-indigo-900">{{ record.session.name }}</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- ApexCharts Script -->
                 <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
                 <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        var options = {
                            series: [{
                                name: '{% trans "Weight" %}',
                                data: [
                                    {% for record in weight_history %}
                                        { x: "{{ record.session.date|date:'Y-m-d' }}", y: {{ record.weight_kg }} },
                                    {% endfor %}
                                ]
                            }],
                            chart: {
                                type: 'line',
                                height: 350,
                                toolbar: { show: false }
                            },
                            stroke: { curve: 'smooth', width: 2 },
                            colors: ['#4f46e5'], // Indigo-600
                            xaxis: { type: 'datetime' },
                            yaxis: { title: { text: 'Kg' } },
                            markers: { size: 4 }
                        };

                        var chart = new ApexCharts(document.querySelector("#weightChart"), options);
                        chart.render();
                    });
                </script>
            {% else %}
                <div class="text-sm text-gray-500 text-center py-4">
                    {% trans "No weight records found." %}
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Movement History Section -->
    <div class="mt-8 overflow-hidden rounded-lg bg-white shadow ring-1 ring-black ring-opacity-5 mb-8">
        <div class="px-4 py-5 sm:px-6">
            <h3 class="text-base font-semibold leading-6 text-gray-900">{% trans "Movement History" %}</h3>
            <p class="mt-1 text-sm text-gray-500">{% trans "Recent locations and transfers." %}</p>
        </div>
        <div class="border-t border-gray-200">
             {% if cattle.movements.exists %}
             <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-300">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-6">{% trans "Date" %}</th>
                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">{% trans "From" %}</th>
                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">{% trans "To" %}</th>
                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">{% trans "Reason" %}</th>
                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">{% trans "By" %}</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 bg-white">
                        {% for movement in cattle.movements.all|slice:":10" %}
                        <tr>
                            <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-6">{{ movement.date|date:"SHORT_DATE_FORMAT" }}</td>
                            <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">{{ movement.origin.name|default:"-" }}</td>
                            <td class="whitespace-nowrap px-3 py-4 text-sm font-medium text-gray-900">{{ movement.destination.name }}</td>
                            <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">{{ movement.get_reason_display }}</td>
                            <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">{{ movement.performed_by.get_full_name|default:movement.performed_by.username }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
             </div>
             {% else %}
             <div class="px-4 py-5 sm:px-6 text-sm text-gray-500 text-center">
                 {% trans "No movement history recorded." %}
             </div>
             {% endif %}
        </div>
    </div>

    <!-- Health History Section -->
    <div class="mt-8 overflow-hidden rounded-lg bg-white shadow ring-1 ring-black ring-opacity-5">
        <div class="px-4 py-5 sm:px-6">
            <h3 class="text-base font-semibold leading-6 text-gray-900">{% trans "Health History" %}</h3>
            <p class="mt-1 text-sm text-gray-500">{% trans "Record of sanitary events, vaccinations, and checks." %}</p>
        </div>
        <div class="border-t border-gray-200">
            {% if health_events %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-300">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-6">{% trans "Date" %}</th>
                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">{% trans "Event" %}</th>
                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">{% trans "Medication" %}</th>
                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">{% trans "Cost" %}</th>
                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">{% trans "Notes" %}</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 bg-white">
                        {% for target in health_events %}
                        <tr>
                            <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-6">{{ target.event.date }}</td>
                            <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">{{ target.event.title }}</td>
                            <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">{{ target.event.medication|default:"-" }}</td>
                            <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">${{ target.cost_capture|default:"0.00" }}</td>
                            <td class="px-3 py-4 text-sm text-gray-500 max-w-xs truncate">{{ target.event.notes|default:"-" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="px-4 py-5 sm:px-6 text-sm text-gray-500 text-center">
                {% trans "No health events recorded." %}
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
