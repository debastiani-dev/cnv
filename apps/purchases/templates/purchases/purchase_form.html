{% extends "layouts/base_dashboard.html" %}
{% load i18n widget_tweaks %}

{% block title %}{{ title|default:_("New Purchase") }}{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8">
    <div class="sm:mx-auto sm:w-full sm:max-w-4xl">
        <h2 class="mt-6 text-center text-2xl font-bold leading-9 tracking-tight text-gray-900 dark:text-white">
            {{ title|default:_("New Purchase") }}
        </h2>
        <p class="mt-2 text-center text-sm text-gray-600 dark:text-gray-400">
            {% trans "Record a new purchase for a partner." %}
        </p>
    </div>

    <div class="mt-10 sm:mx-auto sm:w-full sm:max-w-4xl">
        <div class="bg-white shadow sm:rounded-lg dark:bg-gray-800">
            <div class="px-4 py-5 sm:p-6">
                <form class="space-y-6" method="POST">
                    {% csrf_token %}
                    
                    <!-- Form Errors -->
                    {% if form.errors or items.errors %}
                        <div class="rounded-md bg-red-50 p-4 dark:bg-red-900/20 mb-6">
                            <div class="flex">
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-red-800 dark:text-red-200">{% trans "Please correct the errors below" %}</h3>
                                    {% if form.non_field_errors %}
                                        <div class="mt-2 text-sm text-red-700 dark:text-red-300">{{ form.non_field_errors }}</div>
                                    {% endif %}
                                    {% if items.non_form_errors %}
                                        <div class="mt-2 text-sm text-red-700 dark:text-red-300">{{ items.non_form_errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Master Fields -->
                    <div class="grid grid-cols-1 gap-x-6 gap-y-8 sm:grid-cols-6">
                        <!-- Date -->
                        <div class="sm:col-span-3">
                            <label for="{{ form.date.id_for_label }}" class="block text-sm font-medium leading-6 text-gray-900 dark:text-white">{{ form.date.label }}</label>
                            <div class="mt-2">
                                {% render_field form.date class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6 dark:bg-gray-700 dark:text-white dark:ring-gray-600" %}
                                {% if form.date.errors %}
                                    <p class="mt-2 text-sm text-red-600 dark:text-red-400">{{ form.date.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Partner -->
                        <div class="sm:col-span-3">
                            <label for="{{ form.partner.id_for_label }}" class="block text-sm font-medium leading-6 text-gray-900 dark:text-white">{{ form.partner.label }}</label>
                            <div class="mt-2">
                                {% render_field form.partner class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6 dark:bg-gray-700 dark:text-white dark:ring-gray-600" %}
                                {% if form.partner.errors %}
                                    <p class="mt-2 text-sm text-red-600 dark:text-red-400">{{ form.partner.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>
                        
                         <!-- Notes -->
                        <div class="sm:col-span-6">
                             <label for="{{ form.notes.id_for_label }}" class="block text-sm font-medium leading-6 text-gray-900 dark:text-white">{{ form.notes.label }}</label>
                            <div class="mt-2">
                                {% render_field form.notes class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6 dark:bg-gray-700 dark:text-white dark:ring-gray-600" rows="2" %}
                            </div>
                        </div>
                    </div>

                    <!-- Divider -->
                    <div class="relative py-4">
                        <div class="absolute inset-0 flex items-center" aria-hidden="true">
                            <div class="w-full border-t border-gray-300 dark:border-gray-600"></div>
                        </div>
                        <div class="relative flex justify-start">
                            <span class="bg-white px-2 text-sm text-gray-500 dark:bg-gray-800 dark:text-gray-400">{% trans "Purchase Items" %}</span>
                        </div>
                    </div>

                    <!-- Items Formset -->
                    {{ items.management_form }}
                    <div id="items-container" class="space-y-4">
                        {% for item_form in items %}
                            <div class="item-row grid grid-cols-1 gap-x-4 gap-y-4 sm:grid-cols-12 items-start border-b border-gray-100 pb-4 dark:border-gray-700 last:border-0" data-row-index="{{ forloop.counter0 }}">
                                {% for hidden in item_form.hidden_fields %}{{ hidden }}{% endfor %}
                                
                                <!-- Content Type (Item Type) -->
                                <div class="sm:col-span-2">
                                    <label class="block text-sm font-medium leading-6 text-gray-900 dark:text-white">
                                        {{ item_form.content_type.label }}
                                    </label>
                                    <div class="mt-1">
                                         {% render_field item_form.content_type class="content-type-select block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6 dark:bg-gray-700 dark:text-white dark:ring-gray-600" %}
                                         {% if item_form.content_type.errors %}
                                            <p class="mt-1 text-sm text-red-600">{{ item_form.content_type.errors.0 }}</p>
                                         {% endif %}
                                    </div>
                                </div>

                                <!-- Item Selection (Dynamic) -->
                                <div class="sm:col-span-5">
                                     <label class="block text-sm font-medium leading-6 text-gray-900 dark:text-white">{% trans "Item" %}</label>
                                     <div class="mt-1">
                                         <!-- Visible Select -->
                                         <select class="item-select block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6 dark:bg-gray-700 dark:text-white dark:ring-gray-600">
                                             <option value="">{% trans "Select an item" %}</option>
                                         </select>
                                         
                                         <!-- Hidden Object ID (Actual Field) -->
                                         {% render_field item_form.object_id class="object-id-input" %}
                                         
                                         <!-- Hidden Item Name (UI Helper for Edit) -->
                                         {% render_field item_form.item_name class="hidden" %}
                                         
                                         {% if item_form.object_id.errors %}
                                            <p class="mt-1 text-sm text-red-600">{{ item_form.object_id.errors.0 }}</p>
                                         {% endif %}
                                     </div>
                                </div>
                                
                                <!-- Quantity -->
                                <div class="sm:col-span-2">
                                    <label class="block text-sm font-medium leading-6 text-gray-900 dark:text-white">
                                        {{ item_form.quantity.label }}
                                    </label>
                                    <div class="mt-1">
                                         {% render_field item_form.quantity class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6 dark:bg-gray-700 dark:text-white dark:ring-gray-600" %}
                                    </div>
                                </div>
                                
                                <!-- Unit Price -->
                                <div class="sm:col-span-2">
                                    <label class="block text-sm font-medium leading-6 text-gray-900 dark:text-white">
                                        {{ item_form.unit_price.label }}
                                    </label>
                                    <div class="mt-1">
                                         {% render_field item_form.unit_price class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6 dark:bg-gray-700 dark:text-white dark:ring-gray-600" %}
                                    </div>
                                </div>

                                <!-- Delete -->
                                {% if items.can_delete %}
                                <div class="sm:col-span-1 pt-8 flex justify-end">
                                    <div class="flex items-center">
                                        {{ item_form.DELETE }}
                                        <label for="{{ item_form.DELETE.id_for_label }}" class="sr-only">{% trans "Remove" %}</label>
                                        <button type="button" class="text-gray-400 hover:text-red-500" onclick="document.getElementById('{{ item_form.DELETE.id_for_label }}').click(); this.closest('.item-row').style.display='none';">
                                            <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                 <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>

                    <div class="pt-4">
                        <button type="button" id="add-item" class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 dark:bg-gray-700 dark:text-white dark:ring-gray-600 dark:hover:bg-gray-600">
                            <svg class="-ml-0.5 mr-1.5 h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                            </svg>
                            {% trans "Add Item" %}
                        </button>
                    </div>

                    <!-- Actions -->
                    <div class="flex items-center justify-end gap-x-6 border-t border-gray-900/10 pt-4 dark:border-gray-700">
                        <a href="{% url 'purchases:list' %}" class="text-sm font-semibold leading-6 text-gray-900 dark:text-white">{% trans "Cancel" %}</a>
                        <button type="submit" class="rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">{% trans "Save Purchase" %}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<template id="empty-form-template">
    <div class="item-row grid grid-cols-1 gap-x-4 gap-y-4 sm:grid-cols-12 items-start border-b border-gray-100 pb-4 dark:border-gray-700 last:border-0" data-row-index="__prefix__">
        
        <!-- Content Type -->
        <div class="sm:col-span-2">
            <label class="block text-sm font-medium leading-6 text-gray-900 dark:text-white">{% trans "Item Type" %}</label>
            <div class="mt-1">
                 {% render_field items.empty_form.content_type class="content-type-select block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6 dark:bg-gray-700 dark:text-white dark:ring-gray-600" %}
            </div>
        </div>

        <!-- Item Selection -->
        <div class="sm:col-span-5">
             <label class="block text-sm font-medium leading-6 text-gray-900 dark:text-white">{% trans "Item" %}</label>
             <div class="mt-1">
                 <select class="item-select block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6 dark:bg-gray-700 dark:text-white dark:ring-gray-600">
                     <option value="">{% trans "Select an item" %}</option>
                 </select>
                 {% render_field items.empty_form.object_id class="object-id-input" %}
                 {% render_field items.empty_form.item_name class="hidden" %}
             </div>
        </div>
        
        <div class="sm:col-span-2">
             <label class="block text-sm font-medium leading-6 text-gray-900 dark:text-white">{% trans "Quantity" %}</label>
             <div class="mt-1">
                  {% render_field items.empty_form.quantity class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6 dark:bg-gray-700 dark:text-white dark:ring-gray-600" %}
             </div>
        </div>
        
        <div class="sm:col-span-2">
             <label class="block text-sm font-medium leading-6 text-gray-900 dark:text-white">{% trans "Unit Price" %}</label>
             <div class="mt-1">
                  {% render_field items.empty_form.unit_price class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6 dark:bg-gray-700 dark:text-white dark:ring-gray-600" %}
             </div>
        </div>

        <div class="sm:col-span-1 pt-8 flex justify-end">
            <div class="flex items-center">
                {{ items.empty_form.DELETE }}
                <label class="sr-only">{% trans "Remove" %}</label>
                <button type="button" class="text-gray-400 hover:text-red-500" onclick="this.closest('.item-row').remove()"> <!-- Simplified remove for new rows -->
                    <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                         <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>
    </div>
</template>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const addButton = document.getElementById('add-item');
        const container = document.getElementById('items-container');
        const totalForms = document.getElementById('id_items-TOTAL_FORMS');
        const template = document.getElementById('empty-form-template');

        // Function to bind events to a row
        function bindRowEvents(row) {
            const ctSelect = row.querySelector('.content-type-select');
            const itemSelect = row.querySelector('.item-select');
            const objectIdInput = row.querySelector('.object-id-input');
            
            if (!ctSelect || !itemSelect || !objectIdInput) return;

            // Load items logic
            const loadItems = async (contentTypeId, selectedItemId = null) => {
                itemSelect.innerHTML = '<option value="">{% trans "Loading..." %}</option>';
                itemSelect.disabled = true;

                if (!contentTypeId) {
                    itemSelect.innerHTML = '<option value="">{% trans "Select an item" %}</option>';
                    itemSelect.disabled = true;
                    return;
                }

                try {
                    const response = await fetch(`{% url 'purchases:api-item-lookup' %}?content_type_id=${contentTypeId}`);
                    const data = await response.json();
                    
                    if (data.results) {
                        let options = '<option value="">{% trans "Select an item" %}</option>';
                        data.results.forEach(item => {
                            const isSelected = selectedItemId && String(item.id) === String(selectedItemId) ? 'selected' : '';
                            options += `<option value="${item.id}" ${isSelected}>${item.name}</option>`;
                        });
                        itemSelect.innerHTML = options;
                        itemSelect.disabled = false;
                    } else {
                         itemSelect.innerHTML = '<option value="">{% trans "No items found" %}</option>';
                    }
                } catch (e) {
                    console.error("Failed to load items", e);
                    itemSelect.innerHTML = '<option value="">{% trans "Error loading items" %}</option>';
                }
            };

            // Event listener for Content Type change
            ctSelect.addEventListener('change', function() {
                objectIdInput.value = ''; // Reset selection
                loadItems(this.value);
            });

            // Event listener for Item selection change
            itemSelect.addEventListener('change', function() {
                objectIdInput.value = this.value;
            });

            // Initial load (if editing or previously bound)
            const currentCt = ctSelect.value;
            const currentObjId = objectIdInput.value;
            
            if (currentCt) {
                // If we have an Object ID, we try to load items and select it.
                // NOTE: If we are in edit mode, the itemSelect is initially empty because it's client-side populated.
                // We rely on objectIdInput having a value (from backend initial).
                loadItems(currentCt, currentObjId);
            }
        }

        // Bind existing rows
        document.querySelectorAll('.item-row').forEach(bindRowEvents);

        // Add new row logic
        if (addButton && container && totalForms && template) {
            addButton.addEventListener('click', function(e) {
                e.preventDefault();
                const formIdx = totalForms.value;
                const newFormHtml = template.innerHTML.replace(/__prefix__/g, formIdx);
                
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = newFormHtml;
                const newRow = tempDiv.firstElementChild;
                
                container.appendChild(newRow);
                bindRowEvents(newRow); // Bind events to new row
                
                totalForms.value = parseInt(formIdx) + 1;
            });
        }
    });
</script>
{% endblock %}
