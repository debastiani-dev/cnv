{% extends "layouts/base_dashboard.html" %}
{% load i18n %}

{% block title %}
    {% if object %}
        {% trans "Edit Task" %}
    {% else %}
        {% trans "New Task" %}
    {% endif %}
{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8">
    <div class="sm:mx-auto sm:w-full sm:max-w-xl">
        <h2 class="mt-6 text-center text-2xl font-bold leading-9 tracking-tight text-gray-900">
            {% if object %}
                {% trans "Edit Task" %}
            {% else %}
                {% trans "New Task" %}
            {% endif %}
        </h2>
    </div>

    <div class="mt-10 sm:mx-auto sm:w-full sm:max-w-xl">
        <form class="space-y-6" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            
            {% if form.errors %}
                <div class="rounded-md bg-red-50 p-4">
                    <div class="flex">
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-red-800">{% trans "Please correct the errors below" %}</h3>
                            <ul class="list-disc pl-5 mt-2 text-sm text-red-700">
                                {% for error in form.non_field_errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                                {% for field in form %}
                                    {% for error in field.errors %}
                                        <li>{{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            {% endif %}

            {% for field in form %}
            <div {% if field.name == 'object_id' %}class="hidden"{% endif %}>
                <label for="{{ field.id_for_label }}" class="block text-sm font-medium leading-6 text-gray-900">{{ field.label }}</label>
                <div class="mt-2">
                    {{ field }}
                    {% if field.help_text %}
                        <p class="mt-2 text-xs text-gray-500">{{ field.help_text }}</p>
                    {% endif %}
                </div>
            </div>

            {% if field.name == 'content_type' %}
            <!-- Dynamic Related Item Picker -->
            <div id="related-item-container" class="hidden">
                 <label for="related-item-select" class="block text-sm font-medium leading-6 text-gray-900">{% trans "Related Item" %}</label>
                 <div class="mt-2">
                     <select id="related-item-select" class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                         <option value="">{% trans "--------- " %}</option>
                     </select>
                 </div>
            </div>
            {% endif %}

            {% endfor %}

            <div class="flex items-center justify-end gap-x-6">
                <a href="{% url 'tasks:list' %}" class="text-sm font-semibold leading-6 text-gray-900">{% trans "Cancel" %}</a>
                <button type="submit" class="rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">{% trans "Save" %}</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const contentTypeSelect = document.getElementById('id_content_type');
        const objectIdInput = document.getElementById('id_object_id');
        const relatedContainer = document.getElementById('related-item-container');
        const relatedSelect = document.getElementById('related-item-select');

        // Function to fetch and populate items
        function updateRelatedItems(contentTypeId, currentObjectId) {
            if (!contentTypeId) {
                relatedContainer.classList.add('hidden');
                return;
            }

            fetch(`{% url 'tasks:api-item-lookup' %}?content_type_id=${contentTypeId}`)
                .then(response => response.json())
                .then(data => {
                    relatedSelect.innerHTML = '<option value="">---------</option>';
                    if (data.results) {
                        data.results.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item.id;
                            option.textContent = item.name;
                            if (currentObjectId && String(item.id) === String(currentObjectId)) {
                                option.selected = true;
                            }
                            relatedSelect.appendChild(option);
                        });
                        relatedContainer.classList.remove('hidden');
                    }
                });
        }

        // Event Listeners
        if (contentTypeSelect) {
            contentTypeSelect.addEventListener('change', function() {
                updateRelatedItems(this.value, null);
                objectIdInput.value = ''; // Clear ID on type change
            });

            // Initial load (edit mode)
            if (contentTypeSelect.value) {
                updateRelatedItems(contentTypeSelect.value, objectIdInput.value);
            }
        }

        if (relatedSelect) {
            relatedSelect.addEventListener('change', function() {
                objectIdInput.value = this.value;
            });
        }
    });

    // Simple script to add Tailwind classes to form fields automatically
    document.querySelectorAll('input, select, textarea').forEach(el => {
        // Skip hidden inputs and our custom select
        if (el.type === 'hidden' || el.id === 'related-item-select') return;

        if (!el.classList.contains('block')) {
            el.classList.add('block', 'w-full', 'rounded-md', 'border-0', 'py-1.5', 'text-gray-900', 'shadow-sm', 'ring-1', 'ring-inset', 'ring-gray-300', 'placeholder:text-gray-400', 'focus:ring-2', 'focus:ring-inset', 'focus:ring-indigo-600', 'sm:text-sm', 'sm:leading-6');
        }
        if (el.type === 'checkbox') {
             el.classList.remove('w-full', 'rounded-md', 'border-0', 'py-1.5', 'text-gray-900', 'shadow-sm', 'ring-1', 'ring-inset', 'ring-gray-300', 'placeholder:text-gray-400', 'focus:ring-2', 'focus:ring-inset', 'focus:ring-indigo-600', 'sm:text-sm', 'sm:leading-6');
             el.classList.add('h-4', 'w-4', 'rounded', 'border-gray-300', 'text-indigo-600', 'focus:ring-indigo-600');
        }
    });
</script>
{% endblock %}
